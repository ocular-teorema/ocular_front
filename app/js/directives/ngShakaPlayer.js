//const Ocular_BlackScreen =
//    'data:video/mp4;base64,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';    

//var module = angular.module('Directives');
//module.directive('ngArchivePlayer', function ($timeout) {

//    var cameraRef;
//    var ms;
//    var sourcesData = [];
//    var video;
//    var currentBytesLoaded = 0;
//    var chunkSize = 1024 * 1024;

//    function fetchArrayBuffer(url, startByte, endByte, callback) {
//        var xhr = new XMLHttpRequest();
//        xhr.open('get', url);
//        xhr.setRequestHeader('Range', 'bytes='+startByte+'-'+endByte);
//        xhr.responseType = 'arraybuffer';
//        xhr.onload = function () {
//            callback(xhr.response);
//        };
//        xhr.send();
//    }

//    var onMediaSourceOpen = function () {
//        var sourceBuffer = ms.addSourceBuffer('video/mp4; codecs="avc1.4d401f"');

//        sourceBuffer.onupdateend = function () {
//            if (sourceBuffer.updating) return;
//            var source = sourcesData.shift();
//            if (!source) {
//                return;
//            }
//            sourceBuffer.appendBuffer(source);
//        };

//        var onData = function (data) {
//            if (data.byteLength > 0) {
//                if (sourceBuffer.updating) {
//                    sourcesData.push(data);
//                } else {
//                    sourceBuffer.appendBuffer(data);
//                }

//                currentBytesLoaded += data.byteLength;
//                fetchArrayBuffer(cameraRef.records[0].src, currentBytesLoaded, currentBytesLoaded + chunkSize, onData);
//            }
//        };

//        fetchArrayBuffer(cameraRef.records[0].src, currentBytesLoaded, currentBytesLoaded + chunkSize, onData);
//    };

//    return {
//        'restrict': 'A',
//        'scope': {
//            ngArchivePlayer: '='
//        },
//        'controller': function ($scope) {
//        },

//        'link': function ($scope, element) {
//            video = element.get(0);

//            $scope.$watch('ngArchivePlayer', function (ref) {
//                cameraRef = $scope.ngArchivePlayer;
//                cameraRef.video = video;
//            });

//            $scope.$watch('ngArchivePlayer.records', function (val) {
//                video.pause();
//                video.currentTime = 0;
//                if (val && val.length > 0) {
//                    cameraRef = $scope.ngArchivePlayer;
//                    ms = new MediaSource();
//                    ms.addEventListener('sourceopen', onMediaSourceOpen);
//                    video.src = URL.createObjectURL(ms);
//                    video.play();
//                }
//            });
//        }
//    };
//});

//function OcularShakaManifestGenerator() {
//    this.curId_ = 0;
//    this.config_ = null;
//}

//OcularShakaManifestGenerator.prototype.configure = function (config) {
//    this.config_ = config;
//};

//OcularShakaManifestGenerator.prototype.start = function (uriString, playerInterface) {
//    var _this = this;
//    return new Promise(function (resolve) {
//        var httpRequest = new XMLHttpRequest();
//        httpRequest.onreadystatechange = function () {
//            if (httpRequest.readyState === 4) {
//                if (httpRequest.status === 200) {
//                    var url = new URL(uriString);
//                    resolve(_this.loadManifest_(JSON.parse(httpRequest.responseText),
//                        url.hostname,
//                        Number(url.searchParams.get('startTs')),
//                        Number(url.searchParams.get('endTs'))
//                    ));
//                }
//            }
//        };
//        httpRequest.open('GET', uriString);
//        httpRequest.send();
//    });

//};

//OcularShakaManifestGenerator.prototype.stop = function () {
//    return Promise.resolve();
//};

//OcularShakaManifestGenerator.prototype.loadManifest_ = function (data, serverAddress, periodStartTs, periodEndTs) {
//    var generator = this;
//    var timeline = new shaka.media.PresentationTimeline(null, 0);
//    data.forEach(function (item) {
//        item.startTs = julianIntToDate(item.date);
//        item.endTs = item.startTs + item.end;
//        item.startTs += item.start;
//    });
//    data = data.sort(function (l, r) {
//        if (l.startTs < r.startTs) {
//            return -1;
//        }
//        if (l.startTs > r.startTs) {
//            return 1;
//        }
//        return 0;
//    });

//    var manifest = {
//        presentationTimeline: timeline,
//        minBufferTime: 5,  // seconds
//        offlineSessionIds: [],
//        periods: []
//    };
//    debugger;
//    //var lastEndTs = periodStartTs;
//    var currentLength = 0;
//    for (var i = 0; i < data.length; i++) {
//        //if (data[i].startTs > lastEndTs) {
//        //    manifest.periods.push(
//        //        this.loadPeriod_(i,
//        //            Math.floor((lastEndTs - periodStartTs) / 1000),
//        //            Math.floor((data[i].startTs - periodStartTs) / 1000),
//        //            5031,
//        //            Ocular_BlackScreen, true));

//        //}
//        //lastEndTs = data[i].endTs;
//        //manifest.periods.push(
//        //    this.loadPeriod_(i, 
//        //        Math.floor((data[i].startTs - periodStartTs) / 1000), 
//        //        Math.floor((data[i].endTs - periodStartTs) / 1000),
//        //        data[i].fileSize,
//        //        'http://' + serverAddress + ':8080' + data[i].archivePostfix, false));
//        manifest.periods.push(
//            this.loadPeriod_(i, 
//                Math.floor(currentLength / 1000), 
//                Math.floor((currentLength + data[i].endTs - data[i].startTs) / 1000),
//                data[i].fileSize,
//                'http://' + serverAddress + ':8080' + data[i].archivePostfix, false));
//        currentLength += data[i].endTs - data[i].startTs;
//    }
//    //var duration = (periodEndTs - periodStartTs) / 1000;
//    //timeline.setDuration(duration);  // seconds
//    timeline.setDuration(currentLength / 1000);  // seconds
//    return manifest;
//};

//OcularShakaManifestGenerator.prototype.loadPeriod_ = function (position, startSecond, endSecond, fileSize, url, isBlank) {
//    return {
//        startTime: startSecond,  // seconds, relative to presentation
//        variants: [
//            this.loadVariant_(position, 0, endSecond - startSecond, fileSize, url, isBlank)
//        ],
//        textStreams: []
//    };
//};

//OcularShakaManifestGenerator.prototype.loadVariant_ = function (position, startSecond, endSecond, fileSize, url, isBlank) {

//    return {
//        id: this.curId_++,  // globally unique ID
//        language: 'en',
//        primary: true,
//        audio: null,
//        video: this.loadStream_(position, startSecond, endSecond, fileSize, url, isBlank),
//        bandwidth: 8000,  // bits/sec, audio+video combined
//        drmInfos: [],
//        allowedByApplication: true,  // always initially true
//        allowedByKeySystem: true   // always initially true
//    };
//};

//OcularShakaManifestGenerator.prototype.loadStream_ = function (position, startSecond, endSecond, fileSize, url, isBlank) {
//    var chunkSize = 1024 * 1024; // 1mb
//    var chunkCount = Math.ceil(fileSize / chunkSize);
//    var chunkSeconds = (endSecond - startSecond) / chunkCount;
//    var references = [];
//    for (var i = 0; i < chunkCount; i++) {
//        references.push(this.loadReference_(i,
//            startSecond + Math.floor(i * chunkSeconds),
//            Math.min(endSecond, Math.floor((i + 1) * chunkSeconds)),
//            chunkSize * i,
//            Math.min(chunkSize * (i + 1)), url));
//    }

//    return {
//        id: this.curId_++,  // globally unique ID
//        createSegmentIndex: function () { return Promise.resolve(); },
//        findSegmentPosition: function (seconds) {
//            return isBlank ? 0 : Math.floor(seconds / (endSecond - startSecond));
//        },
//        getSegmentReference: function (pos) {
//            return references[pos];
//        },
//        //segmentIndex:           index,
//        presentationTimeOffset: startSecond,
//        mimeType: 'video/mp4',
//        codecs: isBlank ? 'avc1.f40015': 'avc1.4d4028', //type == 'video' ? 'vp9' : (type == 'audio' ? 'vorbis' : ''),
//        frameRate: 24, //type == 'video' ? 24 : undefined,
//        bandwidth: 8000,  // bits/sec
//        width: isBlank ? 444 : 640, //type == 'video' ? 640 : undefined,
//        height: isBlank ? 286 : 480, //type == 'video' ? 480 : undefined,
//        kind: undefined, //type == 'text' ? 'subtitles' : undefined,
//        channelsCount: undefined, //type == 'audio' ? 2 : undefined,
//        encrypted: false,
//        keyId: null,
//        language: 'en',
//        label: 'archive_stream',
//        type: 'video',
//        primary: false,
//        trickModeVideo: null,
//        containsEmsgBoxes: false,
//        roles: []
//    };
//};

//OcularShakaManifestGenerator.prototype.loadReference_ =
//    function (position, start, end, startByte, endByte, url) {
//        var getUris = function () { return [url]; };
//        return new shaka.media.SegmentReference(
//            position, start, end, getUris,
//            startByte,
//            endByte);
//    };

//// Install built-in polyfills to patch browser incompatibilities.
//shaka.polyfill.installAll();
////shaka.media.ManifestParser.registerParserByExtension('json', OcularShakaManifestGenerator);
//shaka.media.ManifestParser.registerParserByMime('application/json', OcularShakaManifestGenerator);

//var module = angular.module('Directives');
//module.directive('ngShakaPlayer', function ($timeout) {

//    function getByte(uint8Array, prevBuffer, pos) {
//        return pos < 0 ? prevBuffer[prevBuffer.length - i] : uint8Array[pos];
//    }

//    function setByte(uint8Array, pos, val) {
//        if (pos >= 0) uint8Array[pos] = val;
//    }

//    function getInt32(uint8Array, prevBuffer, pos) {
//        return getByte(uint8Array, prevBuffer, pos) << 24 |
//            getByte(uint8Array, prevBuffer, pos + 1) << 16 |
//            getByte(uint8Array, prevBuffer, pos + 2) << 8 |
//            getByte(uint8Array, prevBuffer, pos + 3);
//    }

//    function setInt32(uint8Array, pos, val) {
//        setByte(uint8Array, pos, val >>> 24 & 0xff);
//        setByte(uint8Array, pos + 1, val >>> 16 & 0xff);
//        setByte(uint8Array, pos + 2, val >>> 8 & 0xff);
//        setByte(uint8Array, pos + 3, val & 0xff);
//    }

//    function scanSignature(uint8Array, prevBuffer, pos, signature) {
//        for (var i = 0; i < signature.length; i++) {
//            if (getByte(uint8Array, prevBuffer, pos + i) !== signature.charCodeAt(i))
//                return false;
//        }
//        return true;
//    }

//    function removeBaseDataOffsetResponseFilter(type, response) {
//        console.log('start filtering');
//        var lastPartialMoof = [];
//        var moofSize = 8 + 128;
//        var trafOffset = 24;
//        var tfhdOffset = trafOffset + 8;
//        var trunOffset = tfhdOffset + 56;
//        var responseNumber = 0;
//        var mustReencode = false;
//        var hasMoov = false;
//        var firstMoofPosition = null;
//        responseNumber++;
//        if (type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
//            var buffer = new Uint8Array(response.data);
//            var newBuffer;
//            var i = -lastPartialMoof.length;
//            var ni = 0;
//            while (i < buffer.length) {
//                try {
//                    if (!hasMoov && firstMoofPosition === null && scanSignature(buffer, lastPartialMoof, i, 'moov'))
//                        hasMoov = true;
//                    if (scanSignature(buffer, lastPartialMoof, i, 'moof')) {
//                        if (firstMoofPosition === null)
//                            firstMoofPosition = i - 4;
//                        if (buffer.length - i < moofSize) {
//                            lastPartialMoof = [];
//                            while (i < buffer.length)
//                                lastPartialMoof.push(buffer[i++]);
//                            break;
//                        }
//                        if (scanSignature(buffer, lastPartialMoof, i + trafOffset, 'traf')) {
//                            if (scanSignature(buffer, lastPartialMoof, i + tfhdOffset, 'tfhd')) {
//                                var tfhdFlags = getInt32(buffer, lastPartialMoof, i + tfhdOffset + 4);
//                                var hasBaseDataOffset = tfhdFlags & 1;
//                                if (hasBaseDataOffset) {
//                                    // first time initializing new buffer for re-encoded content
//                                    if (!mustReencode) {
//                                        newBuffer = new Uint8Array(buffer.length);
//                                        mustReencode = true;
//                                        for (ni = 0; ni < i; ni++)
//                                            newBuffer[ni] = buffer[ni];
//                                    }

//                                    for (var k = 0; k < tfhdOffset + 12; k++)
//                                        newBuffer[ni + k] = buffer[i + k];
//                                    moofSize = getInt32(buffer, lastPartialMoof, i - 4);
//                                    var trafSize = getInt32(buffer, lastPartialMoof, i + trafOffset - 4);
//                                    var tfhdSize = getInt32(buffer, lastPartialMoof, i + tfhdOffset - 4);
//                                    setInt32(newBuffer, ni - 4, moofSize - 8);
//                                    setInt32(newBuffer, ni + trafOffset - 4, trafSize - 8);
//                                    setInt32(newBuffer, ni + tfhdOffset - 4, tfhdSize - 8);
//                                    setInt32(newBuffer, ni + tfhdOffset + 4, (tfhdFlags | 0x020000) & 0xfffffffe); // removing base-data-offset flag and setting default-base-is-moof
//                                    for (k = tfhdOffset + 20; k < moofSize; k++)
//                                        newBuffer[ni + k - 8] = buffer[i + k];
//                                    //setInt32(buffer, lastPartialMoof, i+tfhdOffset+8, 0);
//                                    //setInt32(buffer, lastPartialMoof, i+tfhdOffset+8+8, 0);
//                                    if (scanSignature(buffer, lastPartialMoof, i + trunOffset, 'trun')) {
//                                        var dataOffset = getInt32(buffer, lastPartialMoof, i + trunOffset + 12);
//                                        setInt32(newBuffer, ni + trunOffset + 12 - 8, dataOffset - 8);
//                                    } else {
//                                        console.log('resp ', responseNumber, 'trun signature is not in place, position ', i);
//                                    }
//                                    i += moofSize;
//                                    ni += moofSize - 8;
//                                } else {
//                                    if (!mustReencode)
//                                        break;
//                                }
//                            } else {
//                                console.log('resp ', responseNumber, 'tfhd signature is not in place, position ', i);
//                            }
//                        } else {
//                            console.log('resp ', responseNumber, 'traf signature is not in place, position ', i);
//                        }
//                    }
//                    if (newBuffer) {
//                        newBuffer[ni++] = buffer[i];
//                    }
//                }
//                catch (e) {
//                    console.log(e);
//                }
//                finally {
//                    i++;
//                }
//            }
//            if (newBuffer) {
//                response.data = newBuffer.slice(0, response.data.byteLength);
//            }

//            if (!hasMoov && firstMoofPosition !== null) {
//                console.log('buffer slice: start=', firstMoofPosition, 'end=', ni);
//                response.data = response.data.slice(firstMoofPosition, response.data.byteLength);
//            }
//        }
//    }

//    function onErrorEvent(event) {
//        // Extract the shaka.util.Error object from the event.
//        onError(event.detail);
//    }

//    function onError(error) {
//        // Log the error.
//        console.error('Error code', error.code, 'object', error);
//    }

//    return {
//        'restrict': 'A',
//        'scope': {
//            ngShakaPlayer: '=',
//            ref: '='
//        },
//        'controller': function ($scope) {
//        },

//        'link': function ($scope, element) {
//            var video = element.get(0);
//            $scope.ref.shaka = new shaka.Player(video);
//            $scope.ref.shaka.getNetworkingEngine().registerResponseFilter(removeBaseDataOffsetResponseFilter);
//            // Listen for error events.
//            $scope.ref.shaka.addEventListener('error', onErrorEvent);

//            $scope.$watch('ngShakaPlayer', function (url) {
//                // Try to load a manifest.
//                // This is an asynchronous process.
//                $scope.ref.shaka.load(url).then(function () {
//                    // This runs if the asynchronous load is successful.
//                    console.log('The video has now been loaded!');
//                }).catch(onError);  // onError is executed if the asynchronous load fails.
//            });
//        }
//    };
//});

